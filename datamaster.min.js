var DataMaster=function(data,fields,options){function csvToTable(e,t,r){function n(t){for(var r="",n=t.length,l=0;l<n;l++)r+=e[d+l];return t===r&&(d+=n,!0)}var l=[],i=",";t&&(i="\t");var a="\r\n";r&&(a="\n");for(var s="",o=[],f=!1,u=!1,d=0;d<e.length;)f?u?n('"'+i)?(o.push(s),s="",f=!1,u=!1):n('"'+a)?(o.push(s),s="",l.push(o),o=[],f=!1,u=!1):n('""')?s+='"':(s+=e[d],d++):n(i)?(o.push(s),s="",f=!1,u=!1):n(a)?(o.push(s),s="",l.push(o),o=[],f=!1,u=!1):n('""')?s+='"':(s+=e[d],d++):n('"')?(u=!0,f=!0):n(i)?(o.push(s),s="",f=!1,u=!1):n(a)?(l.push(o),o=[],s="",f=!1,u=!1):(s=e[d],f=!0,u=!1,d++);return l}function sortBy(e,t,r){var n=r?function(t){return r(t[e])}:function(t){return t[e]};return t=t?-1:1,function(e,r){return e=n(e),r=n(r),t*((e>r)-(r>e))}}function copy(e){return JSON.parse(JSON.stringify(e))}function findFieldIndex(e,t){if("number"==typeof t)return t<e.length&&t;for(var r=0;r<_fields.length;r++)if(e[r]===t)return r;return!1}function createFields(e){if(void 0===e){_fields=[];for(var t=0;t<_table[0].length;t++)_fields.push(t.toString())}else for(var r=_fields.length<e.length?_fields.length:e.length,n=0;n<r;n++)_fields[n]=e[n]}function recordsetToRecordTable(e){for(var t=Object.keys(e[0]),r=[],n=0;n<e.length;n++){for(var l=[],i=0;i<t.length;i++){var a=t[i];e[n].hasOwnProperty(a)&&l.push(e[n][a])}r.push(l)}return{table:r,fields:t}}function reorderData(e,t,r){var n={table:[],fields:[]};try{for(var l,i=[],a=0;a<r.length;a++){var s=findFieldIndex(t,r[a]);!1!==s&&i.push(s)}for(var o=0;o<e.length;o++){l=[];for(var f=0;f<i.length;f++)l.push(e[o][i[f]]);n.table.push(l)}for(var u=0;u<r.length;u++)"number"==typeof r[u]?n.fields.push(t[r[u]]):!1!==findFieldIndex(t,r[u])&&n.fields.push(r[u])}catch(e){return n}return n}function itemInList(e,t){if(e.constructor!==Array)return!1;for(var r=0;r<e.length;r++)if(e[r]==t)return!0;return!1}function getTableColumn(e,t,r){var n=[];try{for(var l=0;l<e.length;l++)r&&itemInList(n,e[l][t])||n.push(e[l][t]);return n}catch(e){return[]}}function recordtableToRecordset(e){for(var t,r=[],n=0;n<e.table.length;n++){t={};for(var l=0;l<e.fields.length;l++)t[e.fields[l]]=e.table[n][l];r.push(t)}return r}function createCSV(e,t){function r(e){return null==e&&(e=""),e=e.toString(),e=e.replace(/"{2,}/g,'"'),e=e.replace(/"/g,'""'),t.removeNewLines&&(e=e.replace(/(\r\n|\r|\n)/g," ")),e='"'+e+'"',e}void 0===t&&(t={}),void 0===t.newLineString&&(t.newLineString="\r\n"),void 0===t.startCol&&(t.startCol=0),void 0===t.startRow&&(t.startRow=0);var n="";if(!0!==t.skipFields){for(var l=0;l<e.fields.length;l++)n+=r(e.fields[l])+",";n=n.substring(0,n.length-1),n+=t.newLineString}for(var i=t.startRow;i<e.table.length;i++){for(var a=t.startCol;a<e.table[i].length;a++)n+=r(e.table[i][a])+",";n=n.substring(0,n.length-1),n+=t.newLineString}return n}function advancedSearch(query,queryFunctions){function looseCaseInsensitiveCompare(e,t,r){if(null==e||null==t)return!1;e=String(e),t=String(t),r||(e=e.toLowerCase(),t=t.toLowerCase());let n="";for(let e=0;e<t.length;e++)"%"===t[e]?n+=".*":"_"===t[e]?n+=".":n+=t[e];var l=new RegExp(`^${n}$`),i=l.test(e);return i}function parseFunctionString(functionString){var openParenIndex=functionString.indexOf("("),closeParenIndex=functionString.lastIndexOf(")"),functionName=-1===openParenIndex?functionString:functionString.substring(0,openParenIndex);let arrayContent=[];if(-1!==openParenIndex&&-1!==closeParenIndex){var arrayContentString=functionString.substring(openParenIndex+1,closeParenIndex);try{arrayContent=eval("["+arrayContentString+"]")}catch(e){return functionString}}return{name:functionName,params:arrayContent}}function evaluateSingleOperation(e,t){var r=/(=|!=)/g,[n,l,i]=t.split(r);if(i=i.replace(/['"]/g,""),!isNaN(n)&&n<e.length){var a=!1;if("/"===i.charAt(0)){var s=i.substring(1),o=parseFunctionString(s),f=o.name,u=o.params;void 0!==queryFunctions&&(a="function"==typeof queryFunctions[f]?queryFunctions[f](e[n],u):looseCaseInsensitiveCompare(e[n],i))}else a=looseCaseInsensitiveCompare(e[n],i);return a="!="===l?!a:a,a?"true":"false"}return"false"}function replaceAndEvaluateExpressions(e,t){var r=/\d+\s*(?:!=|=)\s*'[^']*'/g;let n,l=t;for(;null!==(n=r.exec(t));){var i=n[0],a=evaluateSingleOperation(e,i);l=l.replace(i,a)}return l}function evaluateLogicalExpression(e){var t=e.split(" OR ");for(var r of t){var n=r.split(" AND ");let e=!0;for(var l of n)if("false"===l){e=!1;break}if(e)return!0}return!1}function evaluateNestedExpression(e){let t=-1,r=-1,n=0;for(let l=0;l<e.length;l++)if("("===e[l])-1===t&&(t=l),n++;else if(")"===e[l]&&(n--,0===n)){r=l;break}if(-1===t||-1===r)return evaluateLogicalExpression(e)?"true":"false";var l=e.substring(t+1,r),i=evaluateNestedExpression(l),a=e.substring(0,t)+i+e.substring(r+1);return evaluateNestedExpression(a)}var resultData=[],resultIndices=[];for(let e=0;e<_fields.length;e++){var fieldName=_fields[e],regExpEqual=new RegExp(fieldName+"=","g");query=query.replace(regExpEqual,e.toString()+"=");var regExpNotEqual=new RegExp(fieldName+"!=","g");query=query.replace(regExpNotEqual,e.toString()+"!=")}for(var d=0;d<_table.length;d++){var booleanExpression=replaceAndEvaluateExpressions(_table[d],query),result=evaluateNestedExpression(booleanExpression);"true"==result&&(resultData.push(_table[d]),resultIndices.push(d))}return Array.isArray(resultData[0])||(resultData=[resultData]),{table:resultData,indices:resultIndices}}var _self=this,_table=[],_fields=[];this.valid=!0,void 0===options&&(options={}),function(){try{if(Array.isArray(data.table)&&Array.isArray(data.fields))_table=copy(data.table),_fields=copy(data.fields);else if(Array.isArray(data[0]))_table=copy(data),createFields(),Array.isArray(fields)?createFields(fields):!0===fields&&(createFields(_table[0]),_table.splice(0,1));else if("string"==typeof data)_table=csvToTable(data,options.isTSV,options.noCR),createFields(),Array.isArray(fields)?createFields(fields):!0===fields&&(createFields(_table[0]),_table.splice(0,1));else{var e=recordsetToRecordTable(data);_table=e.table,createFields(),createFields(e.fields),fields&&createFields(fields)}}catch(e){this.valid=!1}}(),this.debug=function(e){function t(e,t){if("number"==typeof e&&(e=e.toString()),"string"!=typeof e)e=new Array(t+1).join(n);else if(e.length<t)for(var r=e.length;r<t;r++)e+=n;return e}var r="<br>",n="&nbsp";e&&(r="\r\n",n=" ");for(var l=[],i="",a=0;a<_fields.length;a++)l[a]=_fields[a].length;for(var s=0;s<_table.length;s++)for(var o=0;o<_fields.length;o++)i=_table[s][o],!0===i?i="true":!1===i?i="false":null===i?i="null":void 0===i&&(i="undefined"),i.toString().length>l[o]&&(l[o]=i.toString().length);var f=r;f+="-|";for(var u=0;u<_fields.length;u++)f+=t(_fields[u],l[u])+"|";f+=r;for(var d=0;d<_table.length;d++){f+=d+"|";for(var h=0;h<_table[d].length;h++)i=_table[d][h],!0===i?i="true":!1===i?i="false":null===i?i="null":void 0===i&&(i="undefined"),f+=t(i,l[h])+"|";f+=r}return f},this.print=_self.debug,this.copy=function(){return _self.exportAs("recordtable")},this.exportAs=function(e,t){e=e.toLowerCase();var r={};return void 0!==t?Array.isArray(t.fields)&&(r=reorderData(_table,_fields,t.fields)):(r.table=copy(_table),r.fields=copy(_fields)),"table"===e?r.table:"recordset"===e?recordtableToRecordset(r):"recordtable"===e?r:"spreadsheet"===e?(r.table.unshift(_fields),r.table):"csv"===e?createCSV(r,t):null},this.table=function(){return copy(_table)},this.fields=function(){return copy(_fields)},this.getColumn=function(e,t){var r=findFieldIndex(_fields,e);return!1!==r?getTableColumn(_table,r,t):null},this.getRow=function(e,t){if(e>=0&&e<_table.length){t=void 0!==t?t.toLowerCase():"array";var r={table:[_table[e]],fields:_fields};return"table"===t?r.table:"array"===t?r.table[0]:"recordset"===t?recordtableToRecordset(r):"recordtable"===t?r:"object"===t?recordtableToRecordset(r)[0]:null}return null},this.sort=function(e,t){function r(e){var r,n=findFieldIndex(_fields,e);!1!==n&&(r=isNaN(_table[0][n])?function(e){try{return e.toUpperCase()}catch(t){return e}}:parseFloat,_table.sort(sortBy(n,t,r)))}if(e)r(e);else for(var n=_fields.length-1;n>=0;n--)r(_fields[n]);return this},this.reorder=function(e){var t=reorderData(_table,_fields,e);return _table=t.table,_fields=t.fields,this},this.search=function(e){if(void 0===e)return null;if(void 0===e.query)return null;if(void 0===e.style&&(e.style="index"),void 0!==e.searchField&&void 0===e.searchFields&&(e.searchFields=e.searchField),void 0!==e.return&&void 0===e.returnField&&(e.returnField=e.return),e.advanced){void 0===e.queryFunctions&&(e.queryFunctions={});var t=advancedSearch(e.query,e.queryFunctions),r={table:t.table,fields:_fields};return resultIndices=t.indices,"table"===e.style?r.table:"recordset"===e.style?recordtableToRecordset(r):"recordtable"===e.style?r:"index"===e.style&&resultIndices}var n=[];if(void 0===e.searchFields)for(var l=0;l<_table[0].length;l++)n.push(l);else{Array.isArray(e.searchFields)||(e.searchFields=[e.searchFields]);for(var i=0;i<e.searchFields.length;i++)n.push(findFieldIndex(_fields,e.searchFields[i]))}var a=findFieldIndex(_fields,e.returnField),s=!1;!1!==a&&(s=_fields[a]);for(var o,f=[],u="",d=0;d<_table.length;d++)for(var h=0;h<n.length;h++)if("function"==typeof e.query){if(e.query(_table[d][n[h]])){f.push(d);break}}else if(u=_table[d][n[h]],null===u&&(u=""),u.toString().toLowerCase().search(new RegExp(e.query.toString(),"i"))>-1){f.push(d);break}if("index"===e.style)return f;if(o=[],!1!==a)for(l=0;l<f.length;l++)o.push(_table[f[l]][a]);else for(l=0;l<f.length;l++)o.push(_table[f[l]]);if("array"===e.style)return o;var c={table:o,fields:_fields};if(s){var g=[];o.forEach(function(e){g.push([e])}),c.table=g,c.fields=[s]}return"table"===e.style?c.table:"recordset"===e.style?recordtableToRecordset(c):"recordtable"===e.style?c:this},this.replace=function(e,t,r){if(void 0===e)return this;if(void 0===t)return this;void 0===r&&(r=_fields),Array.isArray(r)||(r=[r]),e instanceof RegExp||(e=new RegExp(e.toString(),"ig"));for(var n=0;n<r.length;n++){var l=findFieldIndex(_fields,r[n]);if(!1!==l)for(var i=0;i<_table.length;i++){var a=_table[i][l];null===a&&(a=""),_table[i][l]=a.replace(e,t)}}return this},this.limit=function(e){return e.style="table",_table=_self.search(e),this},this.modifyFieldNames=function(e,t){try{for(var r=0;r<e.length;r++){var n=findFieldIndex(_fields,e[r][0]);!1!==n&&(_fields[n]=e[r][1])}if(t){for(var l=[],i=0;i<e.length;i++)l.push(e[i][1]);_self.reorder(l)}}catch(e){}return this},this.setFieldNames=function(e){for(var t=e.length<_fields.length?e.length:_fields.length,r=0;r<t;r++)_fields[r]=e[r];return this},this.addColumn=function(e,t,r){if(void 0===e)return null;void 0===t&&(t=[]);try{var n,l;if(n=t.slice(0,_table.length),n.length<_table.length)for(var i=n.length;i<_table.length;i++)n.push(null);if(void 0!==r){var a=findFieldIndex(_fields,r);if(!1!==a)for(_fields.splice(a,0,e),l=0;l<_table.length;l++)_table[l].splice(a,0,t[l])}else for(_fields.push(e),l=0;l<_table.length;l++)_table[l].push(t[l])}catch(e){}return this},this.removeColumn=function(e){var t=findFieldIndex(_fields,e);if(!1!==t){_fields.splice(t,1);for(var r=0;r<_table.length;r++)_table[r].splice(t,1)}return this},this.addRow=function(e,t){var r;void 0===e&&(e=[]);try{if(Array.isArray(e)){if(r=e,r.length>_fields.length)r=r.slice(0,_fields.length);else if(r.length<_fields.length)for(var n=r.length;n<_fields.length;n++)r.push(null)}else{r=new Array(_fields.length);for(var l=0;l<r.length;l++)r[l]=null;Object.keys(e).forEach(function(t){var n=findFieldIndex(_fields,t);!1!==n&&(r[n]=e[t])})}"number"==typeof t?(t<0&&(t=0),t>_table.length&&(t=_table.length),_table.splice(t,0,r)):_table.push(r)}catch(e){}return this},this.removeRow=function(e){return e>=0&&e<_table.length&&_table.splice(e,1),this},this.modifyCell=function(e,t,r){try{var n=findFieldIndex(_fields,t);!1!==n&&(_table[e][n]=r)}catch(e){}return this},this.getCell=function(e,t){try{var r=findFieldIndex(_fields,t);if(!1!==r)return _table[e][r]}catch(e){return}},this.length=function(e){return e?_fields.length:_table.length},this.sumColumns=function(e,t,r){if(void 0===t){t=[];for(var n=0;n<_fields.length;n++)t.push(n);"string"==typeof e&&t.shift()}for(var l=[],i=0;i<t.length;i++)if("string"==typeof t[i]){var a=findFieldIndex(_fields,t[i]);!1!==a&&l.push(a)}else t[i]>=0&&t[i]<_fields.length&&l.push(t[i]);for(var s=[],o=[],f=0;f<_fields.length;f++)s.push(null);"string"==typeof e&&(s[0]=e);for(var u=0;u<l.length;u++){var d=0,h=0;o[u]=0;for(var c=0;c<_table.length;c++)h=parseFloat(_table[c][l[u]]),"number"==typeof h&&(d+=h,o[u]++);s[l[u]]=d,r&&o[u]>0&&(s[l[u]]/=o[u])}if("undefined"!=typeof isNaNValue)for(i=0;i<s.length;i++)isNaN(s[i])&&(s[i]=isNaNValue);return this.addRow(s),this},this.sumRows=function(e,t,r,n){null==e&&(e="Total");for(var l=[],i=[],a=0;a<_table.length;a++)l.push(null);if(void 0===t){t=[];for(var s=0;s<_table.length;s++)t.push(s)}for(var o=0;o<t.length;o++)if(t[o]>=0&&t[o]<_table.length){var f=0;i[o]=0;for(var u=0,d=0;d<_fields.length;d++)u=parseFloat(_table[t[o]][d]),"number"==typeof u&&(f+=u,i[o]++);l[t[o]]=f,r&&i[o]>0&&(l[t[o]]/=i[o])}if(void 0!==n)for(s=0;s<l.length;s++)isNaN(l[s])&&(l[s]=n);return _self.addColumn(e,l),this},this.pivot=function(){var e,t,r,n={table:[],fields:[]};try{for(t=0;t<_fields.length-1;t++){for(data=[],r=0;r<_table.length+1;r++)data.push("XXX");n.table.push(data)}for(n.fields=getTableColumn(_table,0),n.fields.unshift(_fields[0]),r=0;r<_fields.length-1;r++)n.table[r][0]=_fields[r+1];for(e=0;e<_fields.length-1;e++)for(r=0;r<_table.length;r++)n.table[e][r+1]=_table[r][e+1];_table=n.table,_fields=n.fields}catch(e){console.log(e)}return this},this.removeDuplicates=function(e){function t(e){for(var t=0;t<r.length;t++)if(r[t][l[0]]==e[l[0]]){for(col=1;col<l.length;col++)if(r[t][col]!=e[col])return!1;return!0}}if(0===_table.length)return this;void 0===e&&(e=_fields),Array.isArray(e)||(e=[e]);for(var r=[],n=null,l=[],i=0;i<e.length;i++)n=findFieldIndex(_fields,e[i]),!1!==n&&l.push(n);r.push(_table[0]);for(var a=0;a<_table.length;a++)t(_table[a])||r.push(_table[a]);return _table=r,this},this.formatColumn=function(e,t){if("function"!=typeof t)return this;var r=findFieldIndex(_fields,e);if(!1===r)return this;for(var n=0;n<_table.length;n++)try{_table[n][r]=t(_table[n][r])}catch(e){}return this},this.formatRow=function(e,t){if("function"!=typeof t)return this;if(e>_self.length())return this;for(var r=0;r<_table[e].length;r++){console.log(r+":"+_table[e][r]);try{_table[e][r]=t(_table[e][r])}catch(e){}}return this}};if("undefined"==typeof window)module.exports=DataMaster;else var jwdm=DataMaster;