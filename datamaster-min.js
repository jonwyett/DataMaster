var DataMaster=function(a,b){function c(a,c,d){var e=d?function(b){return d(b[a])}:function(b){return b[a]};return c=c?-1:1,function(d,f){return d=e(d),f=e(f),c*((d>f)-(f>d))}}function d(a){return JSON.parse(JSON.stringify(a))}function e(a,b){if("number"==typeof b)return b;for(var c=0;c<o.length;c++)if(a[c]===b)return c;return!1}function f(a){if("undefined"==typeof a){o=[];for(var b=0;b<n[0].length;b++)o.push(b)}else for(var c=o.length<a.length?o.length:a.length,d=0;d<c;d++)o[d]=a[d]}function g(a){for(var b=[],c=[],d=[],e=0;e<a.length;e++){c=[],d=Object.keys(a[e]);for(var f=0;f<d.length;f++)c.push(a[e][d[f]]);b.push(c)}return{table:b,fields:d}}function h(a,b,c){var d={table:[],fields:[]};try{for(var g,h=[],j=0;j<c.length;j++)g=e(b,c[j]),!1!==g&&h.push(g);for(var k,l=0;l<a.length;l++){k=[];for(var m=0;m<h.length;m++)k.push(a[l][h[m]]);d.table.push(k)}for(var n=0;n<c.length;n++)"number"==typeof c[n]?d.fields.push(b[c[n]]):!1!==e(b,c[n])&&d.fields.push(c[n])}catch(a){return d}return d}function i(a,b,c){function d(a,b){if(a.constructor!==Array)return!1;for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}var e=[];try{for(var f=0;f<a.length;f++)c?d(e,a[f][b])||e.push(a[f][b]):e.push(a[f][b]);return e}catch(a){return[]}}function j(a){for(var b,c=[],d=0;d<a.table.length;d++){b={};for(var e=0;e<a.fields.length;e++)b[a.fields[e]]=a.table[d][e];c.push(b)}return c}function k(a,b){function d(a){return("undefined"==typeof a||null===a)&&(a=""),a=a.toString(),a=a.replace(/"{2,}/g,"\""),a=a.replace(/"/g,"\"\""),b.removeNewLines&&(a=a.replace(/(\r\n|\r|\n)/g," ")),a="\""+a+"\"",a}"undefined"==typeof b&&(b={}),"undefined"==typeof b.newLineString&&(b.newLineString="\r\n"),"undefined"==typeof b.startCol&&(b.startCol=0),"undefined"==typeof b.startRow&&(b.startRow=0);var e="";if(!0!==b.skipFields){for(var g=0;g<a.fields.length;g++)e+=d(a.fields[g])+",";e=e.substring(0,e.length-1),e+=b.newLineString}for(var h=b.startRow;h<a.table.length;h++){for(var i=b.startCol;i<a.table[h].length;i++)e+=d(a.table[h][i])+",";e=e.substring(0,e.length-1),e+=b.newLineString}return e}var m=this,n=[],o=[];this.valid=!0,function(){try{if(Array.isArray(a.table)&&Array.isArray(a.fields))n=d(a.table),o=d(a.fields);else if(Array.isArray(a[0]))n=d(a),f(),b&&f(b);else{var c=g(a);n=c.table,f(),f(c.fields),b&&f(b)}}catch(a){this.valid=!1}}(),this.debug=function(a){function b(a,b){if("number"==typeof a&&(a=a.toString()),"string"!=typeof a)a=Array(b+1).join(e);else if(a.length<b)for(var d=a.length;d<b;d++)a+=e;return a}var d="<br>",e="&nbsp";a&&(d="\r\n",e=" ");for(var g=[],h=0;h<o.length;h++)g[h]=o[h].length;for(var j=0;j<n.length;j++)for(var k=0;k<o.length;k++)n[j][k]&&n[j][k].toString().length>g[k]&&(g[k]=n[j][k].toString().length);var l=d;l+="-|";for(var m=0;m<o.length;m++)l+=b(o[m],g[m])+"|";l+=d;for(var p=0;p<n.length;p++){l+=p+"|";for(var q=0;q<n[p].length;q++)l+=b(n[p][q],g[q])+"|";l+=d}return l},this.copy=function(){return m.exportAs("recordtable")},this.exportAs=function(a,b){a=a.toLowerCase();var c={};return"undefined"==typeof b?(c.table=d(n),c.fields=d(o)):Array.isArray(b.fields)&&(c=h(n,o,b.fields)),"table"===a?c.table:"recordset"===a?j(c):"recordtable"===a?c:"spreadsheet"===a?(c.table.unshift(o),c.table):"csv"===a?k(c,b):null},this.table=function(){return d(n)},this.fields=function(){return d(o)},this.getColumn=function(a,b){var c=e(o,a);return!1===c?null:i(n,c,b)},this.getRow=function(a,b){if(0<=a&&a<n.length){b="undefined"==typeof b?"array":b.toLowerCase();var c={table:[n[a]],fields:o};return"table"===b?c.table:"array"===b?c.table[0]:"recordset"===b?j(c):"recordtable"===b?c:"object"===b?j(c)[0]:null}return null},this.sort=function(a,b){var d=e(o,a);if(!1!==d){var f;f=isNaN(n[0][d])?function(b){return b.toUpperCase()}:parseFloat,n.sort(c(d,b,f))}return this},this.reorder=function(a){var b=h(n,o,a);return n=b.table,o=b.fields,this},this.search=function(a){if("undefined"==typeof a)return null;if("undefined"==typeof a.query)return null;"undefined"==typeof a.style&&(a.style="index");var b=e(o,a.searchField),d=e(o,a.return),f=!1;!1!==d&&(f=o[d]);for(var g,h=[],k=0;k<n.length;k++)if(b)-1<n[k][b].toString().toLowerCase().search(new RegExp(a.query,"i"))&&h.push(k);else for(var l=0;l<n[k].length;l++)-1<n[k][l].toString().toLowerCase().search(new RegExp(a.query,"i"))&&h.push(k);var m;if("index"===a.style)return h;if(g=[],!1!==d)for(m=0;m<h.length;m++)g.push(n[h[m]][d]);else for(m=0;m<h.length;m++)g.push(n[h[m]]);if("array"===a.style)return g;var p={table:g,fields:o};if(f){var q=[];g.forEach(function(a){q.push([a])}),p.table=q,p.fields=[f]}return"table"===a.style?p.table:"recordset"===a.style?j(p):"recordtable"===a.style?p:this},this.modifyFieldNames=function(a,b){try{for(var c,d=0;d<a.length;d++)c=e(o,a[d][0]),!1!==c&&(o[c]=a[d][1]);if(b){for(var f=[],g=0;g<a.length;g++)f.push(a[g][1]);m.reorder(f)}}catch(a){}return this},this.setFieldNames=function(a){for(var b=a.length<o.length?a.length:o.length,c=0;c<b;c++)o[c]=a[c];return this},this.addColumn=function(a,b,c){if("undefined"==typeof a)return null;"undefined"==typeof b&&(b=[]);try{var d;if(d=b.slice(0,n.length),d.length<n.length)for(var f=d.length;f<n.length;f++)d.push(null);var g;if("undefined"!=typeof c){var h=e(o,c);if(!1!==h)for(o.splice(h,0,a),g=0;g<n.length;g++)n[g].splice(h,0,b[g])}else for(o.push(a),g=0;g<n.length;g++)n[g].push(b[g])}catch(a){}return this},this.removeColumn=function(a){var b=e(o,a);if(!1!==b){o.splice(b,1);for(var c=0;c<n.length;c++)n[c].splice(b,1)}return this},this.addRow=function(a,b){"undefined"==typeof a&&(a=[]);var d;try{if(!Array.isArray(a)){d=Array(o.length);for(var f=0;f<d.length;f++)d[f]=null;Object.keys(a).forEach(function(b){var c=e(o,b);!1!==c&&(d[c]=a[b])})}else if(d=a,d.length>o.length)d=d.slice(0,o.length);else if(d.length<o.length)for(var g=d.length;g<o.length;g++)d.push(null);"number"==typeof b?(0>b&&(b=0),b>n.length&&(b=n.length),n.splice(b,0,d)):n.push(d)}catch(a){}return this},this.removeRow=function(a){return 0<=a&&a<n.length&&n.splice(a,1),this},this.modifyCell=function(a,b,c){try{var d=e(o,b);!1!==d&&(n[a][d]=c)}catch(a){}return this},this.getCell=function(a,b){try{var c=e(o,b);if(!1!==c)return n[a][c]}catch(a){}},this.length=function(){return n.length},this.sumColumns=function(b,d){if("undefined"==typeof d){d=[];for(var f=0;f<o.length;f++)d.push(f);"string"==typeof b&&d.shift()}for(var g=[],h=0;h<d.length;h++)if("string"==typeof d[h]){var j=e(o,d[h]);!1!==j&&g.push(j)}else 0<=d[h]&&d[h]<o.length&&g.push(d[h]);for(var k=[],l=0;l<o.length;l++)k.push(null);"string"==typeof b&&(k[0]=b);for(var m,p=0;p<g.length;p++){m=0;for(var q=0;q<n.length;q++)"number"==typeof n[q][g[p]]&&(m+=n[q][g[p]]);k[g[p]]=m}return this.addRow(k),this},this.sumRows=function(b,d){("undefined"==typeof b||null===b)&&(b="Total");for(var e=[],f=0;f<n.length;f++)e.push(null);if("undefined"==typeof d){d=[];for(var g=0;g<n.length;g++)d.push(g)}for(var h=0;h<d.length;h++)if(0<=d[h]&&d[h]<n.length){for(var j=0,k=0;k<o.length;k++)"number"==typeof n[d[h]][k]&&(j+=n[d[h]][k]);e[d[h]]=j}return m.addColumn(b,e),this},this.pivot=function(){var b,d,e,g={table:[],fields:[]};try{for(d=0;d<o.length-1;d++){for(a=[],e=0;e<n.length+1;e++)a.push("XXX");g.table.push(a)}for(g.fields=i(n,0),g.fields.unshift(o[0]),e=0;e<o.length-1;e++)g.table[e][0]=o[e+1];for(b=0;b<o.length-1;b++)for(e=0;e<n.length;e++)g.table[b][e+1]=n[e][b+1];n=g.table,o=g.fields}catch(a){console.log(a)}return this}};