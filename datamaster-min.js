var DataMaster=function(r,t){var e=this,n=[],l=[];function i(r){return JSON.parse(JSON.stringify(r))}function s(r,t){if("number"==typeof t)return t;for(var e=0;e<l.length;e++)if(r[e]===t)return e;return!1}function o(r){if(void 0===r){l=[];for(var t=0;t<n[0].length;t++)l.push(t.toString())}else for(var e=l.length<r.length?l.length:r.length,i=0;i<e;i++)l[i]=r[i]}function a(r,t,e){var n={table:[],fields:[]};try{for(var l,i=[],o=0;o<e.length;o++){var a=s(t,e[o]);!1!==a&&i.push(a)}for(var h=0;h<r.length;h++){l=[];for(var f=0;f<i.length;f++)l.push(r[h][i[f]]);n.table.push(l)}for(var u=0;u<e.length;u++)"number"==typeof e[u]?n.fields.push(t[e[u]]):!1!==s(t,e[u])&&n.fields.push(e[u])}catch(r){return n}return n}function h(r,t,e){function n(r,t){if(r.constructor!==Array)return!1;for(var e=0;e<r.length;e++)if(r[e]==t)return!0;return!1}var l=[];try{for(var i=0;i<r.length;i++)e&&n(l,r[i][t])||l.push(r[i][t]);return l}catch(r){return[]}}function f(r){for(var t,e=[],n=0;n<r.table.length;n++){t={};for(var l=0;l<r.fields.length;l++)t[r.fields[l]]=r.table[n][l];e.push(t)}return e}this.valid=!0,function(){try{if(Array.isArray(r.table)&&Array.isArray(r.fields))n=i(r.table),l=i(r.fields);else if(Array.isArray(r[0]))n=i(r),o(),Array.isArray(t)?o(t):!0===t&&(o(n[0]),n.splice(0,1));else if("string"==typeof r)n=function(r){var t=[],e="\r\n",n="",l=[],i=!1,s=!1,o=0;function a(t){for(var e="",n=t.length,l=0;l<n;l++)e+=r[o+l];return t===e&&(o+=n,!0)}for(;o<r.length;)i?s?a('",')?(l.push(n),n="",i=!1,s=!1):a('"'+e)?(l.push(n),n="",t.push(l),l=[],i=!1,s=!1):a('""')?n+='"':(n+=r[o],o++):a(",")?(l.push(n),n="",i=!1,s=!1):a(e)?(l.push(n),n="",t.push(l),l=[],i=!1,s=!1):a('""')?n+='"':(n+=r[o],o++):a('"')?(s=!0,i=!0):a(",")?(l.push(n),n="",i=!1,s=!1):a(e)?(t.push(l),l=[],n="",i=!1,s=!1):(n=r[o],i=!0,s=!1,o++);return t}(r),o(),Array.isArray(t)?o(t):!0===t&&(o(n[0]),n.splice(0,1));else{var e=function(r){for(var t=[],e=[],n=[],l=0;l<r.length;l++){e=[],n=Object.keys(r[l]);for(var i=0;i<n.length;i++)e.push(r[l][n[i]]);t.push(e)}return{table:t,fields:n}}(r);n=e.table,o(),o(e.fields),t&&o(t)}}catch(r){this.valid=!1}}(),this.debug=function(r){var t="<br>",e="&nbsp";function i(r,t){if("number"==typeof r&&(r=r.toString()),"string"!=typeof r)r=new Array(t+1).join(e);else if(r.length<t)for(var n=r.length;n<t;n++)r+=e;return r}r&&(t="\r\n",e=" ");for(var s=[],o=0;o<l.length;o++)s[o]=l[o].length;for(var a=0;a<n.length;a++)for(var h=0;h<l.length;h++)n[a][h]&&n[a][h].toString().length>s[h]&&(s[h]=n[a][h].toString().length);var f=t;f+="-|";for(var u=0;u<l.length;u++)f+=i(l[u],s[u])+"|";f+=t;for(var g=0;g<n.length;g++){f+=g+"|";for(var c=0;c<n[g].length;c++)f+=i(n[g][c],s[c])+"|";f+=t}return f},this.copy=function(){return e.exportAs("recordtable")},this.exportAs=function(r,t){r=r.toLowerCase();var e={};return void 0!==t?Array.isArray(t.fields)&&(e=a(n,l,t.fields)):(e.table=i(n),e.fields=i(l)),"table"===r?e.table:"recordset"===r?f(e):"recordtable"===r?e:"spreadsheet"===r?(e.table.unshift(l),e.table):"csv"===r?function(r,t){void 0===t&&(t={}),void 0===t.newLineString&&(t.newLineString="\r\n"),void 0===t.startCol&&(t.startCol=0),void 0===t.startRow&&(t.startRow=0);var e="";function n(r){return null==r&&(r=""),r=(r=(r=r.toString()).replace(/"{2,}/g,'"')).replace(/"/g,'""'),t.removeNewLines&&(r=r.replace(/(\r\n|\r|\n)/g," ")),r='"'+r+'"'}if(!0!==t.skipFields){for(var l=0;l<r.fields.length;l++)e+=n(r.fields[l])+",";e=e.substring(0,e.length-1),e+=t.newLineString}for(var i=t.startRow;i<r.table.length;i++){for(var s=t.startCol;s<r.table[i].length;s++)e+=n(r.table[i][s])+",";e=e.substring(0,e.length-1),e+=t.newLineString}return e}(e,t):null},this.table=function(){return i(n)},this.fields=function(){return i(l)},this.getColumn=function(r,t){var e=s(l,r);return!1!==e?h(n,e,t):null},this.getRow=function(r,t){if(r>=0&&r<n.length){t=void 0!==t?t.toLowerCase():"array";var e={table:[n[r]],fields:l};return"table"===t?e.table:"array"===t?e.table[0]:"recordset"===t?f(e):"recordtable"===t?e:"object"===t?f(e)[0]:null}return null},this.sort=function(r,t){var e,i=s(l,r);!1!==i&&(e=isNaN(n[0][i])?function(r){return r.toUpperCase()}:parseFloat,n.sort(function(r,t,e){var n=e?function(t){return e(t[r])}:function(t){return t[r]};return t=t?-1:1,function(r,e){return r=n(r),e=n(e),t*((r>e)-(e>r))}}(i,t,e)));return this},this.reorder=function(r){var t=a(n,l,r);return n=t.table,l=t.fields,this},this.search=function(r){if(void 0===r)return null;if(void 0===r.query)return null;void 0===r.style&&(r.style="index");var t=s(l,r.searchField),e=s(l,r.return),i=!1;!1!==e&&(i=l[e]);for(var o,a,h=[],u=0;u<n.length;u++)if(t)n[u][t].toString().toLowerCase().search(new RegExp(r.query,"i"))>-1&&h.push(u);else for(var g=0;g<n[u].length;g++)n[u][g].toString().toLowerCase().search(new RegExp(r.query,"i"))>-1&&h.push(u);if("index"===r.style)return h;if(o=[],!1!==e)for(a=0;a<h.length;a++)o.push(n[h[a]][e]);else for(a=0;a<h.length;a++)o.push(n[h[a]]);if("array"===r.style)return o;var c={table:o,fields:l};if(i){var v=[];o.forEach(function(r){v.push([r])}),c.table=v,c.fields=[i]}return"table"===r.style?c.table:"recordset"===r.style?f(c):"recordtable"===r.style?c:this},this.modifyFieldNames=function(r,t){try{for(var n=0;n<r.length;n++){var i=s(l,r[n][0]);!1!==i&&(l[i]=r[n][1])}if(t){for(var o=[],a=0;a<r.length;a++)o.push(r[a][1]);e.reorder(o)}}catch(r){}return this},this.setFieldNames=function(r){for(var t=r.length<l.length?r.length:l.length,e=0;e<t;e++)l[e]=r[e];return this},this.addColumn=function(r,t,e){if(void 0===r)return null;void 0===t&&(t=[]);try{var i,o;if((i=t.slice(0,n.length)).length<n.length)for(var a=i.length;a<n.length;a++)i.push(null);if(void 0!==e){var h=s(l,e);if(!1!==h)for(l.splice(h,0,r),o=0;o<n.length;o++)n[o].splice(h,0,t[o])}else for(l.push(r),o=0;o<n.length;o++)n[o].push(t[o])}catch(r){}return this},this.removeColumn=function(r){var t=s(l,r);if(!1!==t){l.splice(t,1);for(var e=0;e<n.length;e++)n[e].splice(t,1)}return this},this.addRow=function(r,t){var e;void 0===r&&(r=[]);try{if(Array.isArray(r)){if((e=r).length>l.length)e=e.slice(0,l.length);else if(e.length<l.length)for(var i=e.length;i<l.length;i++)e.push(null)}else{e=new Array(l.length);for(var o=0;o<e.length;o++)e[o]=null;Object.keys(r).forEach(function(t){var n=s(l,t);!1!==n&&(e[n]=r[t])})}"number"==typeof t?(t<0&&(t=0),t>n.length&&(t=n.length),n.splice(t,0,e)):n.push(e)}catch(r){}return this},this.removeRow=function(r){return r>=0&&r<n.length&&n.splice(r,1),this},this.modifyCell=function(r,t,e){try{var i=s(l,t);!1!==i&&(n[r][i]=e)}catch(r){}return this},this.getCell=function(r,t){try{var e=s(l,t);if(!1!==e)return n[r][e]}catch(r){return}},this.length=function(){return n.length},this.sumColumns=function(r,t){if(void 0===t){t=[];for(var e=0;e<l.length;e++)t.push(e);"string"==typeof r&&t.shift()}for(var i=[],o=0;o<t.length;o++)if("string"==typeof t[o]){var a=s(l,t[o]);!1!==a&&i.push(a)}else t[o]>=0&&t[o]<l.length&&i.push(t[o]);for(var h=[],f=0;f<l.length;f++)h.push(null);"string"==typeof r&&(h[0]=r);for(var u=0;u<i.length;u++){for(var g=0,c=0;c<n.length;c++)"number"==typeof n[c][i[u]]&&(g+=n[c][i[u]]);h[i[u]]=g}return this.addRow(h),this},this.sumRows=function(r,t){null==r&&(r="Total");for(var i=[],s=0;s<n.length;s++)i.push(null);if(void 0===t){t=[];for(var o=0;o<n.length;o++)t.push(o)}for(var a=0;a<t.length;a++)if(t[a]>=0&&t[a]<n.length){for(var h=0,f=0;f<l.length;f++)"number"==typeof n[t[a]][f]&&(h+=n[t[a]][f]);i[t[a]]=h}return e.addColumn(r,i),this},this.pivot=function(){var t,e,i,s={table:[],fields:[]};try{for(e=0;e<l.length-1;e++){for(r=[],i=0;i<n.length+1;i++)r.push("XXX");s.table.push(r)}for(s.fields=h(n,0),s.fields.unshift(l[0]),i=0;i<l.length-1;i++)s.table[i][0]=l[i+1];for(t=0;t<l.length-1;t++)for(i=0;i<n.length;i++)s.table[t][i+1]=n[i][t+1];n=s.table,l=s.fields}catch(r){console.log(r)}return this}};"undefined"==typeof window&&(exports.DataMaster=DataMaster);